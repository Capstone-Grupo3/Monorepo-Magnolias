name: Sync Frontend to Deployment Repo

on:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-to-deployment:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Monorepo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          path: monorepo

      - name: Checkout Frontend-Magnolias
        uses: actions/checkout@v5
        with:
          repository: SebitaxGod/Frontend-Magnolias
          token: ${{ secrets.FRONTEND_DEPLOY_TOKEN }}
          path: frontend-deployment

      - name: Sync frontend files to deployment repo
        run: |
          echo "ðŸ”„ Syncing frontend files to Frontend-Magnolias..."
          
          # Copiar archivos del frontend del monorepo al repo de deployment
          rsync -av --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='.next' \
            --exclude='.env.local' \
            --exclude='.env*.local' \
            monorepo/frontend/ \
            frontend-deployment/
          
          echo "âœ… Files synced successfully"

      - name: Commit and push to deployment repo
        working-directory: frontend-deployment
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Verificar si hay cambios
          if [[ -n $(git status --porcelain) ]]; then
            git add .
            
            # Obtener el Ãºltimo commit message del monorepo relacionado con frontend
            COMMIT_MSG=$(cd ../monorepo && git log -1 --pretty=%B -- "frontend")
            
            # Crear commit con mensaje multi-lÃ­nea
            git commit -m "chore: sync from monorepo" -m "${COMMIT_MSG}" -m "Synced from monorepo commit: ${{ github.sha }}"
            
            git push origin main
            
            echo "âœ… Changes pushed to Frontend-Magnolias"
            echo "ðŸš€ Vercel will automatically deploy these changes"
          else
            echo "â„¹ï¸ No changes to sync"
          fi

      - name: Create sync summary
        if: always()
        run: |
          echo "## ðŸ“¦ Frontend Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** Capstone-Grupo3/Monorepo-Magnolias" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** SebitaxGod/Frontend-Magnolias" >> $GITHUB_STEP_SUMMARY
          echo "**Path:** \`frontend/\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Vercel Deployment:** Changes will be automatically deployed" >> $GITHUB_STEP_SUMMARY
