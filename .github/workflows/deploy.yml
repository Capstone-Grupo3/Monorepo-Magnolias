name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  # ValidaciÃ³n y creaciÃ³n de release
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=manual-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          fi

      - name: Validate version format
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          if [[ ! ${{ steps.get_version.outputs.version }} =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Error: Version tag must follow semver format (v1.0.0)"
            exit 1
          fi
          echo "âœ… Version format is valid: ${{ steps.get_version.outputs.version }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Build Backend
        working-directory: backend
        run: |
          npm ci
          npm run build

      - name: Build Frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:3000' }}

      - name: Generate Changelog
        id: changelog
        uses: actions/github-script@v7
        with:
          script: |
            const commits = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: context.payload.before || 'HEAD~10',
              head: context.sha
            });
            
            const changelog = commits.data.commits.map(commit => 
              `- ${commit.commit.message.split('\n')[0]} (${commit.sha.substring(0, 7)})`
            ).join('\n');
            
            return changelog || 'No changes detected';

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          release_name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## ðŸš€ Release ${{ steps.get_version.outputs.version }}
            
            **Fecha:** $(date +'%Y-%m-%d %H:%M:%S')
            
            ### ðŸ“ Cambios
            
            ${{ steps.changelog.outputs.result }}
            
            ### ðŸŽ¯ Deployment
            
            Los servicios se desplegarÃ¡n automÃ¡ticamente:
            - **Backend**: Railway detectarÃ¡ este push y deployarÃ¡ automÃ¡ticamente
            - **Frontend**: Vercel detectarÃ¡ este push y deployarÃ¡ automÃ¡ticamente
            
            ### âœ… Builds
            
            - âœ… Backend compilado exitosamente
            - âœ… Frontend compilado exitosamente
            
            ---
            
            **Nota:** Este es un release automÃ¡tico generado por GitHub Actions.
            Los deployments se realizan automÃ¡ticamente por Railway y Vercel.
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.version, 'alpha') || contains(steps.get_version.outputs.version, 'beta') || contains(steps.get_version.outputs.version, 'rc') }}

      - name: Notify Success
        run: |
          echo "âœ… Release ${{ steps.get_version.outputs.version }} creado exitosamente!"
          echo ""
          echo "ðŸ“¦ Los deployments automÃ¡ticos comenzarÃ¡n ahora:"
          echo "  - Railway deployarÃ¡ el backend automÃ¡ticamente"
          echo "  - Vercel deployarÃ¡ el frontend automÃ¡ticamente"
          echo ""
          echo "ðŸ”— Revisa el progreso en:"
          echo "  - Railway Dashboard: https://railway.app"
          echo "  - Vercel Dashboard: https://vercel.com"

